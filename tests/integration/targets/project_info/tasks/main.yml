---
# Copyright: Contributors to the Ansible project
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

- name: Project info module integration tests
  module_defaults:
    group/ansible.eda.eda:
      aap_hostname: "{{ aap_hostname }}"
      aap_username: "{{ aap_username }}"
      aap_password: "{{ aap_password }}"
      aap_validate_certs: "{{ aap_validate_certs }}"

  block:
    - include_tasks: create.yml
    - name: List all projects in the given EDA Controller in check mode
      ansible.eda.project_info:
      check_mode: true
      register: r

    - name: Check if all the projects are returned in check mode
      assert:
        that:
          - "'projects' in r"

    - name: List all projects in the given EDA Controller
      ansible.eda.project_info:
      register: r

    - name: Check if all the projects are returned
      assert:
        that:
          - "'projects' in r"

    - name: List a particular project in the given EDA Controller
      ansible.eda.project_info:
        name: "Example"
      register: r

    - name: Check if the project is returned
      assert:
        that:
          - "'projects' in r"
          - "'Example' in r['projects'][0]['name']"

    - name: List a non-existing particular project in the given EDA Controller
      ansible.eda.project_info:
        name: "Example2"
      register: r

    - name: Check if all the projects are returned
      assert:
        that:
          - "'projects' in r"
          - "r['projects'] == []"

    - name: Create project with auto-sync for info test
      ansible.eda.project:
        name: "TestProjectAutoSync"
        url: "https://github.com/ansible/eda-sample-project"
        description: "Test project with auto-sync"
        organization_name: Default
        update_revision_on_launch: true
        scm_update_cache_timeout: 600
        state: present

    - name: Get project info with sync fields
      ansible.eda.project_info:
        name: "TestProjectAutoSync"
      register: r

    - name: Verify sync-related fields are present
      assert:
        that:
          - "'projects' in r"
          - "r['projects'] | length > 0"
          - "'update_revision_on_launch' in r['projects'][0]"
          - "'scm_update_cache_timeout' in r['projects'][0]"
          - "'last_sync_at' in r['projects'][0] or r['projects'][0].last_sync_at is defined or r['projects'][0].last_sync_at is none"
          - "'sync_status' in r['projects'][0] or r['projects'][0].sync_status is defined or r['projects'][0].sync_status is none"

  always:
    - name: Clean up - project
      ansible.eda.project:
        name: "{{ item }}"
        state: absent
      loop:
        - Example
        - TestProjectAutoSync
      ignore_errors: true
