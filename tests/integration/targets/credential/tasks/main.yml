---
- name: Credential integration tests
  module_defaults:
    group/ansible.eda.eda:
      aap_hostname: "{{ aap_hostname }}"
      aap_username: "{{ aap_username }}"
      aap_password: "{{ aap_password }}"
      aap_validate_certs: "{{ aap_validate_certs }}"
  block:
    - name: Generate a random_string for the test
      set_fact:
        random_string: "{{ lookup('password', '/dev/null chars=ascii_letters length=16') }}"
      when: random_string is not defined

    - name: Generate a ID for the test
      set_fact:
        test_id: "{{ random_string | to_uuid }}"
      when: test_id is not defined

    - name: Define variables for credential and project
      set_fact:
        credential_name: "Test_Credential_{{ test_id }}"
        new_credential_name: "New_Test_Credential_{{ test_id }}"
        credential_copy_name: "Test_Credential_{{ test_id }}_Copy"
        credential_type_name: "Test_CredentialType_{{ test_id }}"

    # CREATE
    - name: Create credential type
      ansible.eda.credential_type:
        name: "{{ credential_type_name }}"
        state: present
        description: "A test credential type"
        inputs:
          fields:
            - id: "field1"
              type: "string"
              label: "Field 5"
        injectors:
          extra_vars:
            field1: "field1"

    - name: Create credential in check mode
      ansible.eda.credential:
        state: present
        name: "{{ credential_name }}"
        description: "This is a test credential"
        credential_type_name: "{{ credential_type_name }}"
        inputs:
          field1: "field1"
        organization_name: Default
      check_mode: true
      register: _result

    - name: Check credential creation in check mode
      assert:
        that:
          - _result.changed

    - name: Create credential
      ansible.eda.credential:
        state: present
        name: "{{ credential_name }}"
        description: "This is a test credential"
        credential_type_name: "{{ credential_type_name }}"
        inputs:
          field1: "field1"
        organization_name: Default
      register: _result

    - name: Check credential creation
      assert:
        that:
          - _result.changed

    - name: Create credential again
      ansible.eda.credential:
        state: present
        name: "{{ credential_name }}"
        description: "This is a test credential"
        credential_type_name: "{{ credential_type_name }}"
        inputs:
          field1: "field1"
        organization_name: Default
      register: _result

    - name: Check credential is not created again
      assert:
        that:
          - not _result.changed

    - name: Get info about a credential
      ansible.eda.credential_info:
        name: "{{ credential_name }}"

    - name: Copy credential
      ansible.eda.credential:
        name: "{{ credential_copy_name }}"
        copy_from: "{{ credential_name }}"
        organization_name: Default
      register: _result

    - name: Check credential is copied
      assert:
        that:
          - _result.changed

    - name: Get info about credentials
      ansible.eda.credential_info:
      register: _credential_info

    - name: Get both created and copied credentials
      set_fact:
        _source_credential: "{{ _credential_info.credentials | selectattr('name', 'equalto', credential_name) | list | first }}"
        _copied_credential: "{{ _credential_info.credentials | selectattr('name', 'equalto', credential_copy_name) | list | first }}"

    - name: Assert credential fields are copied correctly
      ansible.builtin.assert:
        that:
          - _source_credential | dict2items | rejectattr('key', 'in', ignored_fields) | items2dict == _copied_credential | dict2items | rejectattr('key', 'in', ignored_fields) | items2dict
          - _source_credential.name + '_Copy' == _copied_credential.name
      vars:
        ignored_fields:
          - name
          - id
          - created_at
          - updated_at
          - modified_at

    - name: Copy non-existing credential
      ansible.eda.credential:
        name: "{{ credential_copy_name }}"
        copy_from: "invalid_credential"
        organization_name: Default
      register: _result
      ignore_errors: true

    - name: Check credential copy failed
      assert:
        that:
          - _result.failed
          - "\"Unable to access 'id' of the credential to copy from\" in _result.msg"

    - name: Copy credential and use existing name
      ansible.eda.credential:
        name: "{{ credential_copy_name }}"
        copy_from: "{{ credential_name }}"
        organization_name: Default
      register: _result
      ignore_errors: true

    - name: Check credential copy failed
      assert:
        that:
          - _result.failed
          - "'eda credential with this name already exists.' in _result.msg"

    # UPDATE
    - name: Update credential name
      ansible.eda.credential:
        state: present
        name: "{{ new_credential_name }}"
        description: "This is a test credential"
        credential_type_name: "{{ credential_type_name }}"
        inputs:
          field1: "field1"
        organization_name: Default
      register: _result

    - name: Check credential update
      assert:
        that:
          - _result.changed

    - name: Update credential again
      ansible.eda.credential:
        state: present
        name: "{{ new_credential_name }}"
        description: "This is a test credential"
        credential_type_name: "{{ credential_type_name }}"
        inputs:
          field1: "field1"
        organization_name: Default
      register: _result

    - name: Check credential is not updated again
      assert:
        that:
          - not _result.changed
      ignore_errors: true

    - name: Get info about credential
      ansible.eda.credential_info:
        name: "{{ new_credential_name }}"

    - name: List all credentials
      ansible.eda.credential_info:

    - name: Create HashiCorp Vault credential for testing
      ansible.eda.credential:
        state: present
        name: "Test_Vault_Credential_{{ test_id }}"
        description: "HashiCorp Vault credential for testing"
        credential_type_name: "HashiCorp Vault Secret Lookup"
        inputs:
          url: "https://vault.example.com:8200/"
          token: "dummy-token-for-testing"
          api_version: "v2"
          default_auth_path: "token"
        organization_name: Default
      register: _vault_cred

    - name: Test HashiCorp Vault credential connectivity with metadata
      ansible.eda.credential:
        name: "Test_Vault_Credential_{{ test_id }}"
        state: test
        metadata:
          secret_path: "secret/myapp"
          secret_key: "password"
        organization_name: Default
      register: _test_result
      ignore_errors: true

    - name: Check credential test with metadata structure
      assert:
        that:
          - not _test_result.changed
          - (_test_result.test_result is defined and _test_result.credential is defined) or _test_result.failed
        fail_msg: |
          Credential test returned unexpected structure.
          Full result: {{ _test_result }}

    - name: Test credential in check mode to verify test state works
      ansible.eda.credential:
        name: "Test_Vault_Credential_{{ test_id }}"
        state: test
        metadata:
          secret_path: "secret/myapp"
          secret_key: "password"
        organization_name: Default
      check_mode: true
      register: _test_result

    - name: Check that test state works in check mode
      assert:
        that:
          - not _test_result.changed
          - _test_result.test_result is defined
          - _test_result.test_result.success == true
          - "'Check mode' in _test_result.test_result.message"

    # TODO: remove 'ignore_errors' once
    # https://issues.redhat.com/browse/AAP-51130 is resolved.
    - name: Test credential connectivity without metadata
      ansible.eda.credential:
        name: "Test_Vault_Credential_{{ test_id }}"
        state: test
        organization_name: Default
      register: _test_result
      ignore_errors: true

    - name: Check credential test without metadata
      assert:
        that:
          - not _test_result.changed
          - (_test_result.test_result is defined and _test_result.credential is defined) or _test_result.failed

    - name: Test non-existing credential
      ansible.eda.credential:
        name: "NonExistingCredential"
        state: test
        organization_name: Default
      register: _test_result
      ignore_errors: true

    - name: Check test of non-existing credential fails
      assert:
        that:
          - _test_result.failed
          - "'not found' in _test_result.msg"

    # DELETE
    - name: Delete operation type without required name parameter
      ansible.eda.credential:
        state: absent
      ignore_errors: true
      register: _result

    - name: Check if credential name is required
      assert:
        that:
          - _result.failed
          - "'missing required arguments: name' in _result.msg"

    - name: Delete non-existing credential in check mode
      ansible.eda.credential:
        name: "Example2"
        state: absent
      check_mode: true
      register: _result

    - name: Check if delete non-existing credential in check mode
      assert:
        that:
          - not _result.changed

    - name: Delete credential
      ansible.eda.credential:
        name: "{{ new_credential_name }}"
        state: absent
      register: _result

    - name: Check if delete non-existing credential
      assert:
        that:
          - _result.changed
  always:
    - name: Clean up - credential
      ansible.eda.credential:
        name: "{{ item }}"
        state: absent
      loop:
        - "{{ credential_name }}"
        - "{{ new_credential_name }}"
        - "{{ credential_copy_name }}"
        - "Test_Vault_Credential_{{ test_id }}"
      ignore_errors: true

    - name: Clean up - credential type
      ansible.eda.credential_type:
        name: "{{ credential_type_name }}"
        state: absent
      ignore_errors: true
